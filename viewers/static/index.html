<!DOCTYPE html>
<!-- <html manifest="cache.manifest"> -->
<html>

<head>
  <title>DICOM Web Viewer</title>
  <meta charset="UTF-8">
  <meta name="description" content="DICOM Web Viewer (DWV) static version">
  <meta name="keywords" content="DICOM,HTML5,JavaScript,medical,imaging,DWV">
  <link type="text/css" rel="stylesheet" href="../../css/style.css">
  <style type="text/css" >
    body { background-color: #222; color: white;
      margin: 10px; padding: 0; font-size: 80%  }
    #pageHeader h1 { display: inline-block; margin: 0; color: #fff; }
    #pageHeader a { color: #ddf; }
    #pageHeader #toolbar { display: inline-block; float: right; }
    #toolbox li:first-child { list-style-type: none; padding-bottom: 10px; margin-left: -20px; }
    #pageMain { position: absolute; height: 92%; width: 99%; bottom: 5px; left: 5px; background-color: #333; }
    #infotl { color: #333; text-shadow: 0 1px 0 #fff; }
    #infotr { color: #333; text-shadow: 0 1px 0 #fff; }
    #dropBox { margin: 20px; }
  </style>
  <link type="text/css" rel="stylesheet" href="../../ext/jquery-ui/themes/ui-darkness/jquery-ui-1.11.2.min.css">
  <!-- Third party -->
  <script type="text/javascript" src="../../ext/jquery/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="../../ext/jquery-ui/jquery-ui-1.11.2.min.js"></script>
  <script type="text/javascript" src="../../ext/flot/jquery.flot.min.js"></script>
  <script type="text/javascript" src="../../ext/pdfjs/jpx.js"></script>
  <script type="text/javascript" src="../../ext/pdfjs/util.js"></script>
  <script type="text/javascript" src="../../ext/pdfjs/arithmetic_decoder.js"></script>
  <script type="text/javascript" src="../../ext/rii-mango/lossless-min.js"></script>
  <script type="text/javascript" src="../../ext/notmasteryet/jpg.js"></script>
  <script type="text/javascript" src="../../ext/kinetic/kinetic-v5.1.1-06.10.min.js"></script>


  <!-- Local -->
  <script src="../../ext/kinetic/kinectic-loader.js"></script>
  <script type="text/javascript" src="../../src/app/application.js"></script>
  <script type="text/javascript" src="../../src/app/toolboxController.js"></script>
  <script type="text/javascript" src="../../src/app/viewController.js"></script>
  <script type="text/javascript" src="../../src/app/state.js"></script>
  <script type="text/javascript" src="../../src/dicom/dicomParser.js"></script>
  <script type="text/javascript" src="../../src/dicom/dictionary.js"></script>
  <script type="text/javascript" src="../../src/gui/browser.js"></script>
  <script type="text/javascript" src="../../src/gui/filter.js"></script>
  <script type="text/javascript" src="../../src/gui/generic.js"></script>
  <script type="text/javascript" src="../../src/gui/help.js"></script>
  <script type="text/javascript" src="../../src/gui/html.js"></script>
  <script type="text/javascript" src="../../src/gui/layer.js"></script>
  <script type="text/javascript" src="../../src/gui/loader.js"></script>
  <script type="text/javascript" src="../../src/gui/style.js"></script>
  <script type="text/javascript" src="../../src/gui/tools.js"></script>
  <script type="text/javascript" src="../../src/gui/undo.js"></script>
  <script type="text/javascript" src="../../src/image/filter.js"></script>
  <script type="text/javascript" src="../../src/image/geometry.js"></script>
  <script type="text/javascript" src="../../src/image/image.js"></script>
  <script type="text/javascript" src="../../src/image/luts.js"></script>
  <script type="text/javascript" src="../../src/image/reader.js"></script>
  <script type="text/javascript" src="../../src/image/view.js"></script>
  <script type="text/javascript" src="../../src/io/file.js"></script>
  <script type="text/javascript" src="../../src/io/url.js"></script>
  <script type="text/javascript" src="../../src/math/bucketQueue.js"></script>
  <script type="text/javascript" src="../../src/math/point.js"></script>
  <script type="text/javascript" src="../../src/math/scissors.js"></script>
  <script type="text/javascript" src="../../src/math/shapes.js"></script>
  <script type="text/javascript" src="../../src/math/stats.js"></script>
  <script type="text/javascript" src="../../src/tools/draw.js"></script>
  <script type="text/javascript" src="../../src/tools/editor.js"></script>
  <script type="text/javascript" src="../../src/tools/ellipse.js"></script>
  <script type="text/javascript" src="../../src/tools/filter.js"></script>
  <script type="text/javascript" src="../../src/tools/info.js"></script>
  <script type="text/javascript" src="../../src/tools/line.js"></script>
  <script type="text/javascript" src="../../src/tools/livewire.js"></script>
  <script type="text/javascript" src="../../src/tools/protractor.js"></script>
  <script type="text/javascript" src="../../src/tools/rectangle.js"></script>
  <script type="text/javascript" src="../../src/tools/roi.js"></script>
  <script type="text/javascript" src="../../src/tools/scroll.js"></script>
  <script type="text/javascript" src="../../src/tools/toolbox.js"></script>
  <script type="text/javascript" src="../../src/tools/undo.js"></script>
  <script type="text/javascript" src="../../src/tools/windowLevel.js"></script>
  <script type="text/javascript" src="../../src/tools/zoomPan.js"></script>
  <script type="text/javascript" src="../../src/utils/string.js"></script>

  <!-- Launch the app -->
  <script type="text/javascript" src="appgui.js"></script>
  <script type="text/javascript" src="applauncher.js"></script>


  <style>


    #container {width:820px;height:100px;overflow:hidden;}
    #container.rotate90,#container.rotate270 {width:100px;height:820px}
    #image {
      transform-origin: top left; /* IE 10+, Firefox, etc. */
      -webkit-transform-origin: top left; /* Chrome */
      -ms-transform-origin: top left; /* IE 9 */
    }
    #container.rotate90 #image {
      transform: rotate(90deg) translateY(-100%);
      -webkit-transform: rotate(90deg) translateY(-100%);
      -ms-transform: rotate(90deg) translateY(-100%);
    }
    #container.rotate180 #image {
      transform: rotate(180deg) translate(-100%,-100%);
      -webkit-transform: rotate(180deg) translate(-100%,-100%);
      -ms-transform: rotate(180deg) translateX(-100%,-100%);
    }
    #container.rotate270 #image {
      transform: rotate(270deg) translateX(-100%);
      -webkit-transform: rotate(270deg) translateX(-100%);
      -ms-transform: rotate(270deg) translateX(-100%);
    }




    body {


      -moz-border-radius: 10px;
      border-radius: 10px;

      -moz-transition: all 200ms linear;
      -webkit-transition: all 200ms linear;
      -o-transition: all 200ms linear;
      transition: all 200ms linear;
      float: right;
    }


    .drop_hover {
      -moz-box-shadow: 0 0 30px rgba(0, 0, 0, 0.8) inset;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8) inset;
    }

    .draggable {
      display: inline-block;
      margin: 20px 10px 10px 20px;
      padding-top: 20px;
      width: 80px;
      height: 40px;
      /*color: #3D110F;
      background-color: #822520;
      border: 4px solid #3D110F;
      text-align: center;*/
      font-size: 2em;
      cursor: move;

      -moz-transition: all 200ms linear;
      -webkit-transition: all 200ms linear;
      -o-transition: all 200ms linear;
      transition: all 200ms linear;

      -moz-user-select: none;
      -khtml-user-select: none;
      -webkit-user-select: none;
      user-select: none;

    }
  </style>

</head>

<body id="body" ondblclick="showCoords(event)">

<div id="pageHeader">

  <!-- Title -->
  <h1>DICOM Web Viewer
    (<a href="https://github.com/ivmartel/dwv">dwv</a>
    <span class="dwv-version"></span>)</h1>

  <!-- Toolbar -->
  <div id="toolbar"></div>

</div><!-- /pageHeader -->

<div id="pageMain">

  <!-- Open file -->
  <div id="openData" title="File">
    <div id="loaderlist"></div>
    <div id="progressbar"></div>
  </div>

  <!-- Toolbox -->
  <div id="toolbox" title="Toolbox">
    <ul id="toolList"></ul>
  </div>

  <!-- History -->
  <div id="history" title="History"></div>

  <!-- Tags -->
  <div id="tags" title="Tags"></div>

  <!-- Help -->
  <div id="help" title="Help"></div>



  <p><input type="button" id="reset" value="reset" style  ="float: right"  /></p>

  <p><input type="button" id="button1" value = "deplacement " style  ="float: right; z-index: 1000"   /></p>
  <p><input type="button" id="button2" value = "rotate" style  ="float: right; z-index: 1000 "/></p>
  <p><input type="button" id="button3" value = "snap " style  ="float: right; z-index: 1000"   /></p>
  <p><select id="list" style="float: right">
              <option>SÃ©lectionnez votre implant</option>
              <option>Implant test1</option>
              <option>Implant test2</option>
              <option>Implant test3</option>
              <option>Implant test4</option>

  </select>
  </p>


  <div class="drag" style="float: right">



    <!--<img id ='img' src="images/test.jpg" class="draggable" style="width:80px; height:40px; z-index: 500" />
    <img src="images/Implant_dimensionne.png" class="draggable" style= " width:auto; height:auto ; z-index: 500" />-->
    <script type="text/javascript " src="rotate.js"> </script>
    <script src="http://yui.yahooapis.com/3.2.0/build/yui/yui-min.js"></script>

    <script>


      var body = document.getElementById('body');

      console.log("Body taille ",window.innerWidth  ,window.innerHeight  );
      function showCoords(event) {
        var x = event.clientX;
        var y = event.clientY;
        console.log(x,"^^",y);
      }
      YUI().use('node', 'event', function (Y) {
        // The Node and Event modules are loaded and ready to use.
        //

        var corn = Y.one('#canvas');


       // var width = corn.get('offsetBottom');
         var width = corn.getX();
        console.log("this is the width of element canvas", width , corn.getY());


      $(function() {



        var list = document.getElementById('list');
         list.addEventListener('change', function() {

           var canvas1 = document.getElementById("canvas");
           canvas1.style.zIndex = "500" ;
           var canvas2 = document.getElementById("dwv-imageLayer") ;
           canvas2.zIndex = 1 ;

           function readCookie(name) {
             var nameEQ = name + "=";
             var ca = document.cookie.split(';');
             for(var i=0;i < ca.length;i++) {
               var c = ca[i];
               while (c.charAt(0)==' ') c = c.substring(1,c.length);
               if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
             }
             return null;
           }

          var width= parseInt(readCookie("width"));

           var height= parseInt(readCookie("height"));

           console.log("this the lol  image size : ", width,height);
           console.log("this is the dimension of canvas 2 ",canvas2.width,canvas2.height);
          var id_liste = list.selectedIndex ;
          // On affiche le contenu de l'Ã©lÃ©ment <option> ciblÃ© par la propriÃ©tÃ© selectedIndex
          console.log(list.options[list.selectedIndex].innerHTML);
          console.log("id rÃ©elle liste ", id_liste);




           function geturlimplant(){

             var id = id_liste;
             var xhr;
             if (window.XMLHttpRequest) {
               xhr = new XMLHttpRequest();
             }
             else if (window.ActiveXObject)
             {
               xhr = new ActiveXObject("Microsoft.XMLHTTP");
             }
             //on dÃ©finit l'appel de la fonction au retour serveur
             xhr.open("GET", "getimplant.php", false);
             xhr.send(null);
             xhr.responseText;
             var docXML= xhr.responseXML;
             var id_implant = docXML.getElementsByTagName("id");
             var url = docXML.getElementsByTagName("url");

             for ( var i = 0;i< id_implant.length; i++)
             {
               if (id == id_implant.item(i).firstChild.data)
               {
                 var url_ultime =  url.item(i).firstChild.data;
               }
             }
             return url_ultime;
           }

           var canvas = document.getElementById("canvas");
           var ctx = canvas.getContext("2d");
           console.log(ctx);

           var canvasOffset = $("#canvas").offset();
           var offsetX = canvasOffset.left ;
           var offsetY = canvasOffset.top   ;

           var isDown = false;

           var cx = canvas.width / 2;
           var cy = canvas.height / 2;


           var w;
           var h;
           var r = 0;
           var img = new Image;
           img.onload = function () {
             w = img.width ;
             h = img.height;
             draw();
           }
           img.src = geturlimplant();


           function draw() {
             ctx.clearRect(0, 0, canvas.width,canvas.height);
             drawRotationHandle(false);
             drawRect();
           }

           function drawRect() {
             ctx.save();
             ctx.translate(0,0);
             ctx.rotate(r);
             ctx.drawImage(img, 0, 0, img.width, img.height);
             ctx.restore();
           }

           function drawRotationHandle(withFill) {
             ctx.save();
             ctx.translate(0, 0);
             ctx.rotate(r);
             ctx.beginPath();
             ctx.moveTo(0, -1);
             ctx.lineTo(w / 2 + 20, -1);
             ctx.lineTo(w / 2 + 20, -7);
             ctx.lineTo(w / 2 + 30, -7);
             ctx.lineTo(w / 2 + 30, 7);
             ctx.lineTo(w / 2 + 20, 7);
             ctx.lineTo(w / 2 + 20, 1);
             ctx.lineTo(0, 1);
             ctx.closePath();
             if (withFill) {
               ctx.fillStyle = "blue";
               ctx.fill();
             }
             ctx.restore();
           }



           var element = document.getElementById("button1");
           element.addEventListener('click', function(){


             var canvasOffset = $("#canvas").offset();
             var offsetX = canvasOffset.left ;
             var offsetY = canvasOffset.top   ;
             console.log(offsetX,"    ",offsetY);

             $( ".draggable2" ).draggable({
               disabled: false
             });

             $( ".draggable2" ).draggable( "option", "disabled", false );
             $("body").droppable({
               accept: ".draggable"
             });
             $(".draggable2").draggable({
               revert: 'invalide'
             });
             $(".draggable").draggable({
               revert: 'invalide'
             });
             $( ".draggable" ).draggable({
               stop: function( event, ui ) {}
             });


           },false)


           var element2 = document.getElementById("button2");
           element2.addEventListener('click', function(){


             $( ".draggable2" ).draggable({
               disabled: true
             });

             $( ".draggable2" ).draggable( "option", "disabled", true );
             $(".draggable").draggable({
               revert: 'valide'
             });

             var canvas = document.getElementById("canvas")

             var ctx = canvas.getContext("2d");

             var canvasOffset = $("#canvas").offset();
             var offsetX = canvasOffset.left;
             var offsetY = canvasOffset.top;

             var isDown = false;
             var cx = canvas.width /2;
             var cy = canvas.height / 2;
             var w;
             var h;
             var r = 0;
             var img = new Image;
             img.onload = function () {
               w = img.width;
               h = img.height ;
               draw();
             }
             img.src = geturlimplant();


             function draw() {
               ctx.clearRect(0, 0, canvas.width, canvas.height);
               drawRotationHandle(true);
               drawRect();
             }
             function drawRect() {
               ctx.save();
               ctx.translate(cx, 400);
               ctx.rotate(r);
               ctx.drawImage(img, 0, 0, img.width, img.height, -w / 2, -h / 2, w, h);
               ctx.restore();
             }
             function drawRotationHandle(withFill) {
               ctx.save();
               ctx.translate(cx, 400);
               ctx.rotate(r);
               ctx.beginPath();
               ctx.moveTo(0, 1);
               ctx.lineTo(w / 2 + 10, -1);
               ctx.lineTo(w / 2 + 10, -7);
               ctx.lineTo(w / 2 + 20, -7);
               ctx.lineTo(w / 2 + 20, 7);
               ctx.lineTo(w / 2 + 10, 7);
               ctx.lineTo(w / 2 + 10, 1);
               ctx.lineTo(0, 1);
               ctx.closePath();
               if (withFill) {
                 ctx.fillStyle = "blue";
                 ctx.fill();
               }
               ctx.restore();
             }
             function handleMouseDown(e) {
               mouseX = parseInt(e.clientX - offsetX);
               mouseY = parseInt(e.clientY - offsetY);
               drawRotationHandle(false);
               isDown = ctx.isPointInPath(mouseX, mouseY);
               console.log(isDown);
             }
             function handleMouseUp(e) {
               isDown = false;
             }
             function handleMouseOut(e) {
               isDown = false;
             }
             function handleMouseMove(e) {
               if (!isDown) {
                 return;
               }
               mouseX = parseInt(e.clientX - offsetX);
               mouseY = parseInt(e.clientY - offsetY);
               var dx = mouseX - cx;
               var dy = mouseY - cy;
               r = Math.atan2(dy, dx);
               draw();
             }

             $("#canvas").mousedown(function (e) {
               handleMouseDown(e);
             });
             $("#canvas").mousemove(function (e) {
               handleMouseMove(e);
             });
             $("#canvas").mouseup(function (e) {
               handleMouseUp(e);
             });
             $("#canvas").mouseout(function (e) {
               handleMouseOut(e);
             });
             $("body").droppable({
               accept: ".draggable"
             });




           },false)


           var element = document.getElementById("button3");
           element.addEventListener('click', function(){




             $( ".draggable2" ).draggable({
               disabled: false
             });

             $( ".draggable2" ).draggable( "option", "disabled", false );
             $("body").droppable({
               accept: ".draggable"
             });
             $(".draggable2").draggable({
               revert: 'invalide'
             });
             $(".draggable").draggable({
               revert: 'invalide'
             });
             $( ".draggable" ).draggable({
               stop: function( event, ui ) {}
             });



             function MaxId()
             {
               var xhr;



               if (window.XMLHttpRequest) {
                 xhr = new XMLHttpRequest();
               }
               else if (window.ActiveXObject)
               {
                 xhr = new ActiveXObject("Microsoft.XMLHTTP");
               }
               //on dÃ©finit l'appel de la fonction au retour serveur

               xhr.open("GET", "getdata.php", false);
               xhr.send(null);
               xhr.responseText;
               var docXML= xhr.responseXML;
               var a = docXML.getElementsByTagName("x");
               var b = docXML.getElementsByTagName("y");
               var  X = a.item(0).firstChild.data;
               var Y  = b.item(0).firstChild.data;

               console.log(X,Y);


              // function showCoords(event) {
                 var canvas = document.getElementById("canvas");
                 canvas.width = canvas.width *2 ;
               canvas.height = canvas.height *2 ;
                 var ctx = canvas.getContext("2d");
                 var x = event.clientX;
                 var  y= event.clientY;

               var canvas = document.getElementById("canvas");
               var ctx = canvas.getContext("2d");



               var imagesize = document.getElementById("dwv-drawDiv");
               var imagelayer = document.getElementById("dwv-imageLayer") ;

               function readCookie(name) {
                 var nameEQ = name + "=";
                 var ca = document.cookie.split(';');
                 for(var i=0;i < ca.length;i++) {
                   var c = ca[i];
                   while (c.charAt(0)==' ') c = c.substring(1,c.length);
                   if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
                 }
                 return null;
               }

               var width= readCookie("width");
               var imagewidth = Number(width);

               var height= readCookie("height");
               var imageheight = Number(height);


               var houss1 = ( X * imagelayer.width) /width ;
               var houss2 = ( Y * imagelayer.height ) / height;


           /*    var houss1 = ( X * 1078) /3264 ;
               var houss2 = ( Y * 806) / 2448;*/

               var canvas = document.getElementById("canvas");
               var ctx = canvas.getContext("2d");
               ctx.clearRect(0, 0, 2*canvas.width, 2*canvas.height);
               ctx.translate(houss1,houss2);
               ctx.drawImage(img, 0, 0, img.width, img.height, -w / 2, -h / 2, w, h);
               ctx.restore();


                console.log("les cooordonÃ©Ã©es " , houss1,houss2);

                console.log("imgage taille", img.width, "   ", img.height);


               //}

             };
             MaxId();
           },false)




        }, true);





          $(".draggable").draggable({
          revert: 'valide'
        });


        $("body").droppable({
          accept: ".draggable"
        });

        $("#reset").click(function () {
          $(".draggable").animate({
            top: "0px",
            left: "0px"
          });

        });

      });


      });


    </script>



  </div>

  <!-- Layer Container -->
  <div id="layerDialog" title="Image" style="z-index: 10 ">
    <div id="dwv-dropBox" class="dropBox" ></div>
    <div id="dwv" class="layerContainer">
      <div class="drop" style="z-index: 1">
        <canvas id="canvas"  class="draggable2" width="800" height="900" style="  position:absolute" ></canvas>
        <canvas id="dwv-imageLayer" class="imageLayer">Only for HTML5 compatible browsers...</canvas>
      </div>

      <div id="dwv-drawDiv" class="drawDiv"></div>
      <div id="dwv-infoLayer" class="infoLayer">
        <div id="dwv-infotl" class="infotl"></div>
        <div id="dwv-infotr" class="infotr"></div>
        <div id="dwv-infobl" class="infobl"></div>
        <div id="dwv-infobr" class="infobr"><div id="dwv-plot" class="plot"></div>
        </div>
      </div><!-- /infoLayer -->
    </div><!-- /layerContainer -->
  </div><!-- /layerDialog -->



</div>


</div><!-- /pageMain -->




</body>
</html>
